---
async function getLatestCommit(slug: string) {
	try {
		const response = await fetch("https://api.github.com/repos/jfrome1/ntw2029/commits?path=src/content/docs/" 
		+ slug);
		if (!response.ok) {
			throw new Error('Network response was not ok');
		}
		const data = await response.json();
		return data[0].commit.author.date; 
	} catch (error) {
		console.error('Error fetching data:', error);
		return null;
	}
}

function formatCommitDate(dateString: string | null) {
	if (!dateString) return "Unknown";
	
	const commitDate = new Date(dateString);
	const currentDate = new Date();
	const diffTime = Math.abs(currentDate.getTime() - commitDate.getTime());
	const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
	
	if (diffDays > 30) {
		return "Older than one month";
	} else {
		return commitDate.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
	}
}
---
<div>Last updated: {formatCommitDate(await getLatestCommit(Astro.props.entry.id))}</div>
<p style={{color: "var(--sl-color-gray-3)"}}>Send me questions or feedback about the website via Teams or email for class participation credit.</p>

<script>
import posthog from "posthog-js";

    const config = {
      users: [
        { id: "user1", name: "Max Hedgehog" },
        { id: "user2", name: "Alice Sparrow" },
        { id: "user3", name: "Charlie Doe" }
      ],
      cookieName: 'userPreference',
      postHogConfig: {
        apiKey: 'phc_t4s4Co4gEm9fzWcHpFUF7zWLFIwv2sR9TiXiNnY74fh',
        apiHost: 'https://us.i.posthog.com',
        personProfiles: 'identified_only'
      }
    };
    
    // Cookie handling functions
    function setCookie(name: string, value: string | number | boolean) {
      try {
        const expires = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toUTCString(); // 30 days
        document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Strict; Secure`;
      } catch (error) {
        console.error('Error setting cookie:', error);
      }
    }
    
    function getCookie(name: string) {
      try {
        return document.cookie
          .split('; ')
          .find(row => row.startsWith(`${name}=`))
          ?.split('=')[1];
      } catch (error) {
        console.error('Error reading cookie:', error);
        return null;
      }
    }
    
    // User management functions
    function getRandomUser() {
      return config.users[Math.floor(Math.random() * config.users.length)];
    }
    
    function initializeUser() {
      try {
        const savedUser = getCookie(config.cookieName);
        if (savedUser) {
          const parsedUser = JSON.parse(decodeURIComponent(savedUser));
          if (parsedUser?.id && parsedUser?.name) {
            return parsedUser;
          }
        }
        const newUser = getRandomUser();
        setCookie(config.cookieName, JSON.stringify(newUser));
        return newUser;
      } catch (error) {
        console.error('Error initializing user:', error);
        return getRandomUser();
      }
    }
    
    // Tracking functions
    // function hasUserConsent() {
    //   return false; 
    // }
    
    function initializeTracking(user: { id: string | undefined; name: any; }) {
      try {
        if (typeof posthog === 'undefined') {
          throw new Error('PostHog is not loaded');
        }
    
        posthog.init(config.postHogConfig.apiKey, {
          api_host: config.postHogConfig.apiHost,
          persistence: 'memory',
          person_profiles: 'identified_only',
        });
    
        // if (hasUserConsent()) {
          posthog.identify(user.id, {
            name: user.name,
            timestamp: new Date().toISOString()
          });
        //}
      } catch (error) {
        console.error('Error initializing tracking:', error);
      }
    }
    
    function initialize() {
      const user = initializeUser();
      initializeTracking(user);
      return user;
    }
    
    // Usage
    const currentUser = initialize();

    window.addEventListener("load", function () {
    let readEventTriggered = false;

    function handleDetails() {
      const detailsElements = document.querySelectorAll("details");
      detailsElements.forEach((details) => {
        const summary = details.querySelector("summary");
        if (summary) {
          summary.addEventListener("click", () => {
            if (!details.open) {
              // Record the time the details is opened
              details.setAttribute("data-open-time", Date.now().toString());
              posthog.capture("openQuiz", {
                page: document.title,
                text: summary.textContent,
              });
              console.log(summary.textContent);
            } else {
              // Calculate duration it was open for
              const openTime = parseInt(details.getAttribute("data-open-time") || "0");
              const duration = Date.now() - openTime;
              posthog.capture("closeQuiz", {
                page: document.title,
                text: summary.textContent,
                duration: duration,
              });
              details.removeAttribute("data-open-time");
            }
          });
        }
      });
    }

    handleDetails();

    const documentDetailObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node instanceof HTMLElement) {
            const newDetailsElements = node.querySelectorAll("details");
            newDetailsElements.forEach((details) => {
              const summary = details.querySelector("summary");
              if (summary) {
                summary.addEventListener("click", () => {
                      if (!details.open) {
                        posthog.capture("openQuiz", {
                    page: document.title,
                    text: summary.textContent,
                  });
                    details.setAttribute("data-open-time", Date.now().toString());
                  } else {
                    const openTime = parseInt(details.getAttribute("data-open-time") || "0");
                    const duration = Date.now() - openTime;
                          posthog.capture("closeQuiz", {
                      page: document.title,
                      text: summary.textContent,
                      duration: duration,
                    });
                    details.removeAttribute("data-open-time");
                  }
                });
              }
            });
          }
        });
      });
    });
    documentDetailObserver.observe(document.body, { childList: true, subtree: true });

    // Handle nutshell links
    function handleNutshellInactive(link: { getAttribute: (arg0: string) => any; textContent: any; removeAttribute: (arg0: string) => void; }) {
      const openTime = parseInt(link.getAttribute("data-open-time") || "0");
      if (openTime === 0) return;
      const duration = Date.now() - openTime;
      posthog.capture("inactiveNutshell", {
        text: link.textContent,
        duration: duration,
      });
      link.removeAttribute("data-open-time");
    }

    function handleNutshellClick(event: { currentTarget: any; }) {
      const link = event.currentTarget;
      const currentMode = link.getAttribute("mode");
      if (currentMode === "open") {
        posthog.capture("openNutshell", {
          page: document.title,
          text: link.textContent,
        });
        link.setAttribute("data-open-time", Date.now().toString());
      } else if (currentMode === "closed") {
        handleNutshellInactive(link);
      }
    }

    function addNutshellListener(link: { hasAttribute: (arg0: string) => any; addEventListener: (arg0: string, arg1: (event: any) => void) => void; setAttribute: (arg0: string, arg1: string) => void; }) {
      if (!link.hasAttribute("listener-added")) {
        link.addEventListener("click", handleNutshellClick);
        link.setAttribute("listener-added", "true");
      }
    }

    function addLinkListener(link: { classList: { contains: (arg0: string) => any; }; hasAttribute: (arg0: string) => any; addEventListener: (arg0: string, arg1: (event: any) => void) => void; setAttribute: (arg0: string, arg1: string) => void; }) {
      if (!link.classList.contains("nutshell-expandable") && !link.hasAttribute("link-listener-added")) {
        link.addEventListener("click", handleLinkClick);
        link.setAttribute("link-listener-added", "true");
      }
    }

    function handleLinkClick(event: { currentTarget: any; }) {
      const link = event.currentTarget;
      const isExternal = link.target === "_blank";
      const eventName = isExternal ? "externalLinkClick" : "internalLinkClick";
      posthog.capture(eventName, {
        text: link.textContent,
        link: link.href,
      });
    }

    function addInitialListeners() {
      const nutshellLinks = document.querySelectorAll(".nutshell-expandable");
      nutshellLinks.forEach(addNutshellListener);
      const allLinks = document.querySelectorAll("a");
      allLinks.forEach(addLinkListener);
    }

    addInitialListeners();

    window.addEventListener("scroll", handleScroll);

    function handleScroll() {
      if (!readEventTriggered) {
        const scrollPosition = window.scrollY + window.innerHeight;
        const totalHeight = document.documentElement.scrollHeight;
        if (scrollPosition >= totalHeight / 2) {
          posthog.capture("read", { page: document.title });
          readEventTriggered = true;
          window.removeEventListener("scroll", handleScroll);
        }
      }
    }

    const documentObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === "childList") {
          mutation.addedNodes.forEach((node) => {
            if (node instanceof HTMLElement) {
              const newNutshellLinks = node.querySelectorAll(".nutshell-expandable");
              newNutshellLinks.forEach(addNutshellListener);
              const newLinks = node.querySelectorAll("a");
              newLinks.forEach(addLinkListener);
            }
          });
        }
      });
    });
    documentObserver.observe(document.body, { childList: true, subtree: true });
  });
    </script>

<style>
  .container {
    max-width: 600px;
    width: 100%;
    margin: 0 auto;
    background-color: var(--sl-color-black);
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    flex-direction: column;
    display: flex;
    transition:
      background-color 0.3s,
      box-shadow 0.3s;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid  var(--sl-color-gray-4);
    border-radius: 4px;
    resize: vertical;
    min-height: 100px;
    box-sizing: border-box;
    transition:
      background-color 0.3s,
      color 0.3s,
      border-color 0.3s;
    background-color:  var(--sl-color-black)
    color: #f0f0f0;
    border-color: #555;
  }

  button {
    display: block;
    width: 100%;
    padding: 10px;
    background-color: var(--sl-color-accent);
    color: #ffffff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
  }

  button:hover {
    opacity: 0.8;
  }
  #message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #message.show {
            opacity: 1;
        }

        #message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
</style>
